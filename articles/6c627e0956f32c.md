---
title: "M1 MacBook Proã§Stable Diffusionã‚’å‹•ã‹ã™ã¾ã§ã®ãƒ¡ãƒ¢"
emoji: "ğŸ¼"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ai, StableDiffusion]
published: true
---

ç”»åƒç”ŸæˆAIã®Stable DiffusionãŒã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã¨ã—ã¦å…¬é–‹ã•ã‚Œã¾ã—ãŸã­ã€‚ã•ã£ããå‹•ã‹ã—ã¦ã¿ãŸã„ãªã¨æ€ã£ã¦è§¦ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸãŒã€æ‰‹å…ƒã«ã‚ã‚‹ã®ã¯MacBookã ã‘ãªã®ã§ã€ãªã‹ãªã‹å¤§å¤‰ã§ã—ãŸã€‚

https://github.com/CompVis/stable-diffusion

ã‚ã‚ŠãŒãŸã„ã“ã¨ã«ã€å…ˆäººãŒãŸãã•ã‚“ã„ã‚‹ã®ã§å‚è€ƒã«ã—ã¦ç’°å¢ƒæ§‹ç¯‰ãŒã§ãã¾ã—ãŸï¼

https://github.com/CompVis/stable-diffusion/issues/25

ãŸã¶ã‚“ãã‚Œãªã‚Šã«ã™ãã«ã™ã‚“ãªã‚Šå‹•ã‹ã›ã‚‹ã‚ˆã†ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã‘ã©ã€ä»Šã™ãã‚„ã£ã¦ã¿ãŸãã¦ãƒˆãƒ©ãƒ–ã£ã¦ã‚‹äººã®å‚è€ƒã«ãªã‚Œã°ã¨ã€ã‚ã‚Šã¨ãªãã‚Šæ›¸ãã§æç¸®ã§ã™ãŒæ›¸ã„ã¦ãŠãã¾ã™ã€‚

# å‹•ä½œé€Ÿåº¦ã¨ã‹

ã¡ãªã¿ã«æ°—ã«ãªã‚‹å®Ÿè¡Œé€Ÿåº¦ã§ã™ãŒã€è‡ªåˆ†ãŒä½¿ã£ã¦ã„ã‚‹ã®ã¯MacBookPro 14ã‚¤ãƒ³ãƒãƒ¢ãƒ‡ãƒ«ã®ä¸€ç•ªã‚¹ãƒšãƒƒã‚¯ãŒä½ã„ã‚„ã¤ã§ã—ã¦

- 8ã‚³ã‚¢CPUã€14ã‚³ã‚¢GPUã€16ã‚³ã‚¢Neural Engineæ­è¼‰Apple M1 Pro
- ãƒ¡ãƒ¢ãƒª32GB

ã§ã™ã€‚

ç”»åƒç”Ÿæˆä¸­ã¯15ã€œ20GBã»ã©ãƒ¡ãƒ¢ãƒªã‚’æ¶ˆè²»ã—ã€5åˆ†ã»ã©ã§ç”»åƒãŒ6æšç”Ÿæˆã§ãã¾ã™ã€‚

# å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—ã™ã‚‹

macOSç‰¹æœ‰ã®ã“ã¨ã¯ãªã„ã§ã™ã€‚

https://huggingface.co/CompVis/stable-diffusion-v-1-4-original ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã—ã¦ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã€‚

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹

https://github.com/CompVis/stable-diffusion/pull/47 ã®PRã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€https://github.com/magnusviri/stable-diffusion/tree/apple-silicon-mps-support ã®ãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã€‚

# ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

condaã‚³ãƒãƒ³ãƒ‰ã¨rustã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚homebrewã§å…¥ã‚Šã¾ã—ãŸã€‚

```sh
brew install anaconda miniconda rust
```

ã‚·ã‚§ãƒ«ã«å¿œã˜ãŸç’°å¢ƒæ§‹ç¯‰ã‚’ã—ã¾ã™ã€‚è‡ªåˆ†ã¯zshã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã“ã‚“ãªæ„Ÿã˜ã€‚ã¡ãªã¿ã«ã“ã‚Œã€`~/.zshrc`ã®æœ«å°¾ã«è‡ªå‹•çš„ã«ã‚ã‚Œã“ã‚Œè¿½åŠ ã™ã‚‹ã®ã§ã€ã‚ã¨ã§å¥½ã¿ã«å¿œã˜ã¦å¤‰æ›´ã—ãŸã»ã†ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚

```sh
conda init zsh
```

stable-diffusionã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ã€`conda env`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã„ã‚ã„ã‚ç’°å¢ƒãŒç•°ãªã‚‹çš„ãªã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```sh
$ conda env create -f environment-mac.yaml
Collecting package metadata (repodata.json): done
Solving environment: failed

ResolvePackageNotFound:
  - python=3.8.5
```

ãªã®ã§ã€è‡ªåˆ†ã®ç’°å¢ƒã«ã‚ã‚ã›ã¦environment-mac.yamlã‚’ç·¨é›†ã—ã¾ã—ãŸã€‚å…·ä½“çš„ã«ã¯ã€æ‰‹å…ƒã®ç’°å¢ƒã«ã‚ã‚ã›ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å¤‰ãˆã¡ã‚ƒã†æ„Ÿã˜ã§ã™ã€‚

`ResolvePackageNotFound`ã®ã‚¨ãƒ©ãƒ¼ãŒæ¶ˆãˆã‚‹ã¨ã€ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå§‹ã¾ã‚Šã¾ã™ã€‚è‡ªåˆ†ã®å ´åˆã€opencv-pythonã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã£ãŸã®ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æŒ‡å®šæ–¹æ³•ã‚’å¤‰ãˆã¦ã„ã¾ã™ã€‚ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã«ç¶šãã‹ã‚‰å†é–‹ã™ã‚‹ã«ã¯ã€`update`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```sh
$ conda env update -f environment-mac.yaml
```

è‡ªåˆ†ã®æœ€çµ‚çš„ãªenvironment-mac.yamlã¯ã“ã‚“ãªé¢¨ã«ãªã‚Šã¾ã—ãŸã€‚

```diff
diff --git a/environment-mac.yaml b/environment-mac.yaml
index d923d56..c8a0a8e 100644
--- a/environment-mac.yaml
+++ b/environment-mac.yaml
@@ -3,14 +3,14 @@ channels:
   - pytorch
   - defaults
 dependencies:
-  - python=3.8.5
-  - pip=20.3
+  - python=3.9.12
+  - pip=21.2.4
   - pytorch=1.12.1
   - torchvision=0.13.1
   - numpy=1.19.2
   - pip:
     - albumentations==0.4.3
-    - opencv-python==4.1.2.30
+    - opencv-python>=4.1.2.30
     - pudb==2019.2
     - imageio==2.9.0
     - imageio-ffmpeg==0.4.2
```

æ¬¡ã«activateã‚’ã—ã¾ã™ã€‚

```sh
conda activate ldm
```

å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã«ãƒªãƒ³ã‚¯ã‚’è²¼ã‚Šã¾ã™ã€‚å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®é€šã‚Šã§ã™ã­ã€‚

```sh
mkdir -p models/ldm/stable-diffusion-v1
ln -s /path/to/stable-diffusion-v-1-4-original/sd-v1-4.ckpt models/ldm/stable-diffusion-v1/model.ckpt
```

# ç”»åƒéŒ¬æˆã«æŒ‘æˆ¦ï¼

ç’°å¢ƒãŒã§ããŸã®ã§æ—©é€ŸéŒ¬æˆã—ãŸã„ã¨ã“ã‚ã§ã™ãŒã€ã“ã®ã¾ã¾txt2imageã‚’å®Ÿè¡Œã—ã¦ã‚‚PyTorché–¢é€£ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã—ã¾ã„ã¾ã™ã€‚

```sh
$ python scripts/txt2img.py --prompt "a photograph of an astronaut riding a horse" --plms 
ã€œ ä¸­ç•¥ ã€œ
NotImplementedError: The operator 'aten::index.Tensor' is not current implemented for the MPS device. If you want this op to be added in priority during the prototype phase of this feature, please comment on https://github.com/pytorch/pytorch/issues/77764. As a temporary fix, you can set the environment variable `PYTORCH_ENABLE_MPS_FALLBACK=1` to use the CPU as a fallback for this op. WARNING: this will be slower than running natively on MPS. (ldm) hawk:~/ghq/../magnusviri/stable-diffusion
```

PyTorchã®nightlyãŒå¿…è¦ãªã®ã§å…¥ã‚Œã¾ã™ã€‚

```sh
conda install pytorch torchvision torchaudio -c pytorch-nightly
```

ã“ã‚Œã§ã‚‚ã¾ã ã‚¨ãƒ©ãƒ¼ãŒã§ã¾ã™ã€‚

```sh
$ python scripts/txt2img.py --prompt "a photograph of an astronaut riding a horse" --plms 
    return torch.layer_norm(input, normalized_shape, weight, bias, eps, torch.backends.cudnn.enabled)
RuntimeError: view size is not compatible with input tensor's size and stride (at least one dimension spans across two contiguous subspaces). Use .reshape(...) instead.
```

https://github.com/CompVis/stable-diffusion/issues/25#issuecomment-1221667017 ã«è¨˜è¼‰ã®é€šã‚Šã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãæ›ãˆã¾ã™ã€‚

```sh
vi /opt/homebrew/Caskroom/miniconda/base/envs/ldm/lib/python3.9/site-packages/torch/nn/functional.py
```

ã¡ãªã¿ã«å¤‰æ›´ç®‡æ‰€ã¯ã“ã†ã€‚

```diff
--- functional.py_      2022-08-23 17:07:29.000000000 +0900
+++ functional.py       2022-08-23 17:07:31.000000000 +0900
@@ -2506,9 +2506,9 @@ def layer_norm(
     """
     if has_torch_function_variadic(input, weight, bias):
         return handle_torch_function(
-            layer_norm, (input, weight, bias), input, normalized_shape, weight=weight, bias=bias, eps=eps
+            layer_norm, (input.contiguous(), weight, bias), input, normalized_shape, weight=weight, bias=bias, eps=eps
         )
-    return torch.layer_norm(input, normalized_shape, weight, bias, eps, torch.backends.cudnn.enabled)
+    return torch.layer_norm(input.contiguous(), normalized_shape, weight, bias, eps, torch.backends.cudnn.enabled)
```

ã§ããŸã€œï¼ï¼ï¼

```sh
$ python scripts/txt2img.py --prompt "a photograph of an astronaut riding a horse" --plms 
...
Your samples are ready and waiting for you here:
outputs/txt2img-samples

Enjoy.
```

# ã¾ã¨ã‚

ã„ã‚„ã™ã”ã„ã§ã™ã­ã€‚æ™‚é–“ã‹ã‹ã‚‹ã¨ã¯ã„ãˆã€æ™®æ®µä½¿ã£ã¦ã„ã‚‹ãƒã‚·ãƒ³ã§ã‚‚ç”»åƒéŒ¬æˆãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ãªã‚“ã¦ã³ã£ãã‚Šã€‚ã„ã‚ã„ã‚ãƒ†ã‚¹ãƒˆãŒã—ã‚„ã™ãã†ã§è‰¯ã„ã§ã™ã€‚

