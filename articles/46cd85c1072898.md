---
title: "Flutterç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹Isarã¨Riverpodã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ã†"
emoji: "ğŸ¼"
type: "tech"
topics: ["flutter", "riverpod", "isar"]
published: true
---

å€‹äººçš„ã«ä½œã‚ŠãŸã„ã‚¢ãƒ—ãƒªãŒã‚ã‚‹ã®ã§ã€Flutterã§é–‹ç™ºã‚’ã—ã¦ã„ã¾ã™ã€‚ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ã§å‹•ã‹ã—ãŸã‹ã£ãŸã®ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ããƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã„ãã¤ã‹æ¤œè¨ã—ã€æœ€çµ‚çš„ã«Isarã¨ã„ã†ã‚„ã¤ã‚’ä½¿ã„ã¯ã˜ã‚ã¾ã—ãŸã€‚

https://isar.dev/ja/

NoSQLã§ã‚¹ã‚­ãƒ¼ãƒãƒ¬ã‚¹ãªã®ã§ã‚ãšã‚‰ã‚ã—ã„è¨­å®šã¿ãŸã„ãªã‚‚ã®ã¯ãªã„ã—ã€æ¡ä»¶ã‚’æŒ‡å®šã—ã¦çµã‚Šè¾¼ã¿ã‚’ã—ã¤ã¤å¤‰æ›´ãŒã‚ã‚‹ã‹ã‚’ç›£è¦–ã§ãã‚‹ã—ã€ãªã‹ãªã‹è‰¯ã„ã§ã™ã€‚ãªã«ã‚ˆã‚Šãƒ¢ãƒ‡ãƒ«ã®ã‚¯ãƒ©ã‚¹ãŒã‚·ãƒ³ãƒ—ãƒ«ã«è¨˜è¿°ã§ãã‚‹ã®ãŒæ°—ã«å…¥ã£ã¦ã¾ã™ã€‚

ã¡ãªã¿ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¯”è¼ƒã«ã¯ã“ã®è¾ºã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚ObjectBoxã‚‚æ°—ã«ãªã£ã¦ã¾ã™ã€‚

https://kabochapo.hateblo.jp/entry/2020/02/01/144411
https://blog.logrocket.com/comparing-hive-other-flutter-app-database-options/

ã•ã¦ã€Flutterã§ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ãªã‚‰ã‚‚ã¡ã‚ã‚“Riverpodã¯ä½¿ã„ã¾ã™ã‚ˆã­ã¨ã€‚

ã¨ã„ã†ã“ã¨ã§ã€Isarã¨Riverpodã‚’çµ„ã¿åˆã‚ã›ã‚‹ã®ã£ã¦ã©ã‚“ãªæ„Ÿã˜ã‹ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚riverpod_generatorã‚‚ä½¿ã£ã¦ã„ã¾ã™ã€‚

https://github.com/ktakayama/IsarRiverpodSample

ä»¥ä¸‹ç°¡å˜ã«ã‚³ãƒ¼ãƒ‰ã®è§£èª¬ã‚’ã—ã¾ã™ã€‚

## ãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹

é©å½“ãªå€¤ãŒä¿å­˜ã§ãã‚‹`Memo`ã¨ã‹ã„ã†ãƒ¢ãƒ‡ãƒ«ã‚’ä½œã£ã¦ã„ã¾ã™ã€‚

```dart:lib/models/memo.dart
@collection
class Memo {
  Memo({
    required this.title,
    required this.body,
    required this.updated,
  })  : id = Isar.autoIncrement,
        created = DateTime.now();

  Id id;

  final String title;
  final String body;

  final DateTime created;
  final DateTime updated;

  String fullTitle() {
    return 'ID: $id: title';
  }
}
```

## Isarã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼

Isarã®åˆæœŸåŒ–ã¯`isarProvider`ã¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚ã“ã‚Œã§ã©ã“ã‹ã‚‰ã§ã‚‚å‘¼ã¹ã‚‹ã‚ˆã†ã«ãªã£ã¦æœ€é«˜ã§ã™ã€‚

```dart:lib/providers/isar_provider.dart 
@Riverpod(keepAlive: true)
Future<Isar> isar(IsarRef ref) async {
  return Isar.open([MemoSchema]);
}
```

riverpod_generatorä½¿ã£ã¦ã‚‹ã®ã§ã‚ã‹ã‚Šã«ãã„ã‹ã‚‚ã§ã™ãŒã€ã“ã‚Œã§`isarProvider`ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

## Memoã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹

`Memo`ã®å†…å®¹ã‚’èª­ã¿æ›¸ãã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã“ã“ã¯Riverpodã‚ã‚“ã¾é–¢ä¿‚ãªãã¦ã€è¿½åŠ ã‚„å¤‰æ›´ã€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒã§ãã‚‹ã‚ˆã†ãªã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ãƒ©ã‚¹ã§ã™ã€‚


```dart:lib/services/memo_service.dart
class MemoService {
  const MemoService(this.isar);
  final Isar isar;

  // æŒ‡å®šã—ãŸIDã®ãƒ¡ãƒ¢ã‚’è¿”ã™
  Stream<Memo> watchMemo(Id id) async* {
    final query = isar.memos.where().idEqualTo(id);

    await for (final results in query.watch(fireImmediately: true)) {
      if (results.isNotEmpty) {
        yield results.first;
      }
    }
  }

  // ã™ã¹ã¦ã®ãƒ¡ãƒ¢ã‚’è¿”ã™
  Stream<List<Memo>> watchAllMemos() async* {
    final query = isar.memos.where().sortByUpdated().build();

    await for (final results in query.watch(fireImmediately: true)) {
      if (results.isNotEmpty) {
        yield results;
      } else {
        yield [];
      }
    }
  }

  // ãƒ¡ãƒ¢ã‚’è¿½åŠ 
  Future<Memo> addMemo() async {
    final randomString = Random().nextInt(10000).toString();
    final title = 'title$randomString';
    final memo = Memo(title: title, body: 'body', updated: DateTime.now());
    await isar.writeTxn(() async {
      await isar.memos.put(memo);
    });
    return memo;
  }

  // æŒ‡å®šã—ãŸIDã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤
  removeMemo(int id) async {
    await isar.writeTxn(() async {
      await isar.memos.delete(id);
    });
  }
}
```

ä»¥ä¸Šã®ã‚ˆã†ã«watchãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã¨ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¤‰æ›´ãŒç›£è¦–ã§ãã¾ã™ã€‚Riverpodã¨çµ„ã¿åˆã‚ã›ã‚„ã™ã„ã‚“ã˜ã‚ƒãªã„ã‹ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

https://isar.dev/ja/watchers.html

## Memoã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼

ã•ã£ãã®`MemoService`ã‚¯ãƒ©ã‚¹ã‚’ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ä¾‹ãˆã° `ref.watch(memoListProvider)` ã¨ã—ã¦ãƒ¡ãƒ¢ã®ä¸€è¦§ã‚„ã€`ref.watch(memoDetailProvider(id))`ã¨ã—ã¦å€‹åˆ¥ã®ãƒ¡ãƒ¢ã®çŠ¶æ…‹ãŒå–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚


```dart:lib/providers/memo_service_provider.dart
@Riverpod(keepAlive: true)
Future<MemoService> memoService(MemoServiceRef ref) async {
  final isar = await ref.watch(isarProvider.future);
  return MemoService(isar);
}

@riverpod
Stream<Memo> memoDetail(MemoDetailRef ref, Id id) async* {
  final service = await ref.watch(memoServiceProvider.future);
  yield* service.watchMemo(id);
}

@riverpod
Stream<List<Memo>> memoList(MemoListRef ref) async* {
  final service = await ref.watch(memoServiceProvider.future);
  yield* service.watchAllMemos();
}
```

`memoListProvider`ã‚‚`memoDetailProvider`ã‚‚`StreamProvider`ã§ã™ã‹ã‚‰ã€éåŒæœŸã§ãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦ãã‚‹ãŸã‚ã®å‡¦ç†ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€`final memos = ref.watch(memoListProvider).value;`ã¿ãŸã„ã«èª­ã¿è¾¼ã‚“ã§ã„ã¦ã€nullãƒã‚§ãƒƒã‚¯ã‚’ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ãŒã‚ã‚‹ã¨ã™ãã«åæ˜ ã•ã‚Œã‚‹ã®ã§ä¾¿åˆ©ã§ã™ã­ï¼

## ãƒ†ã‚¹ãƒˆ

ãªã«ã’ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã®ãŒå¤§å¤‰ã§ã—ãŸã€‚Isarã®å ´åˆã¯ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã ã¨äº‹å‰ã«ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã•ã‚‰ã«ã€ãƒ†ã‚¹ãƒˆã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ãŸã„ã®ã§ãã®ãŸã‚ã®å·¥å¤«ã‚‚ã—ã¦ã„ã¾ã™ã€‚

æœ€çµ‚çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå…±é€šé–¢æ•°ã‚’ç”¨æ„ã—ã¦ã€Isarã‚’ä½¿ã„ãŸã„å ´åˆã«å‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```dart:test/test_utils.dart
Future<ProviderContainer> createContainer(
    {List<Override> overrides = const []}) async {

  // ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  final evacuation = HttpOverrides.current;
  HttpOverrides.global = null;
  await Isar.initializeIsarCore(download: true);
  HttpOverrides.global = evacuation;

  // Isarã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”¨æ„
  final random = Random().nextInt(10000).toString();
  final isar = await Isar.open(
    [MemoSchema],
    name: 'test_${random}_tmp',
  );

  // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®override
  final container = ProviderContainer(
      overrides: overrides + [isarProvider.overrideWith((ref) => isar)]);

  // çµ‚äº†å‡¦ç†
  addTearDown(() async {
    await isar.close(deleteFromDisk: true);
    container.dispose();
  });

  return container;
}
```

Isarã¨Riverpodã‚’èª­ã¿åˆã‚ã›ã¦ã‚ã‚Œã“ã‚Œã—ãŸã„äººã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

