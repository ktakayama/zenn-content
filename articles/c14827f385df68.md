---
title: ".gitãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­ã§Vitestã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹è©±"
emoji: "ğŸ¼"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["vitest", "svelte", "npm"]
published: true
publication_name: arm_techblog
---

æ–°ã—ãWebã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ãŸã‚ã«ã¾ãšã¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã‚‹ç’°å¢ƒã‚’ä½œã‚ã†ã¨ã€[Vitest](https://vitest.dev/)ã‚’ä½¿ã£ãŸç’°å¢ƒæ§‹ç¯‰ã‚’ã—ã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€ `Error: Cannot find module '/@vite/env'` ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã€ã©ã†ã«ã‚‚ã“ã†ã«ã‚‚è§£æ¶ˆã§ãã¾ã›ã‚“ã€‚AIã«ä»»ã›ãŸã¨ã“ã‚ã€ä¸€ç”Ÿã‚ã‚Œã“ã‚Œè©¦è¡ŒéŒ¯èª¤ã—ã¦ã„ã¦è§£æ±ºã—ãã†ãªé›°å›²æ°—ãŒã¾ã£ãŸãã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

`Vitest`ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³3ç³»ã‚’ä½¿ã†ã¨ã“ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã‚‚ã®ã®ã€2ç³»ã‚’ä½¿ãˆã°å•é¡Œãªã„ã“ã¨ã¯ã‚ã‹ã‚Šã¾ã—ãŸã€‚ã¨ã¯ã„ãˆæ°—æŒã¡æ‚ªã„ã®ã§ã©ã†ã«ã‹ãªã‚‰ãªã„ã‹èª¿ã¹ã€åŸå› ãŒã‚ã‹ã£ãŸã®ã§åŒæ§˜ã®å•é¡Œã«æ‚©ã‚€æ–¹ã®ãŸã‚ã«è¨˜äº‹ã«ã—ã¾ã™ã€‚

çµè«–ã‚’è¨€ã†ã¨**ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹ã«`.git`ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ**ã«å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚æœ€è¿‘ä½¿ã„å§‹ã‚ãŸ[phantom](https://github.com/aku11i/phantom)ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§ã€ãƒ¯ãƒ¼ã‚¯ãƒ„ãƒªãƒ¼ã®å±•é–‹å…ˆãŒ`.git/phantom/worktrees`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã®ãŸã‚ã€ã“ã®å•é¡Œã«é­é‡ã—ã¾ã—ãŸã€‚

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¨ã—ã¦ã¯ã€ã“ã®ã‚ˆã†ãªçŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

```
  PROJECT_ROOT/
  â”œâ”€â”€ .git/
  â”‚   â””â”€â”€ phantom/
  â”‚       â””â”€â”€ worktrees/ â† ãƒ¯ãƒ¼ã‚¯ãƒ„ãƒªãƒ¼ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã“ã“ã®ä¸‹ã«å±•é–‹
  â”‚           â””â”€â”€ feature-branch1/ â† ã“ã“ã§ Vitest ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
  â”‚           â””â”€â”€ feature-branch2/
  â””â”€â”€ ï¼ˆé€šå¸¸ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç½®ãå ´ï¼‰
```

å…·ä½“çš„ãªå•é¡Œã®å†…å®¹ã¨åŸå› ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## èª¿æŸ»ã®ãŸã‚ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

ä»Šå›ã€å•é¡Œèª¿æŸ»ã®ãŸã‚ã«æœ€å°æ§‹æˆã«ãªã‚‹ã‚ˆã†ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã£ã¦è©¦ã—ã¦ã„ã¾ã—ãŸã€‚Svelteã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ä½œã£ã¦ã„ã¾ã™ã€‚

https://svelte.dev/docs/svelte/testing

æœ€çµ‚çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã§ãƒ†ã‚¹ãƒˆã‚’ã—ã¾ã—ãŸã€‚

```json:package.json
{
  "name": "frontend",
  "private": true,
  "version": "0.0.1",
  "type": "module",
  "scripts": {
    "test": "vitest"
  },
  "devDependencies": {
    "@sveltejs/kit": "^2.16.0",
    "@testing-library/jest-dom": "^6.6.3",
    "jsdom": "^26.1.0",
    "svelte": "^5.0.0",
    "typescript": "^5.0.0",
    "vitest": "3.2.4"
  }
}
```

```ts:multiplier.svelte.ts
export function multiplier(getCount: () => number, k: number) {
  return {
    get value() {
      return getCount() * k;
    },
  };
}
```

```js:multiplier.svelte.test.js
import { flushSync } from "svelte";
import { expect, test } from "vitest";
import { multiplier } from "./multiplier.svelte.ts";

test("Multiplier", () => {
  let count = 0;
  let double = multiplier(() => count, 2);

  expect(double.value).toEqual(0);

  count = 5;

  expect(double.value).toEqual(10);
});
```

```ts:vite.config.ts
/// <reference types="vitest" />
import { defineConfig } from "vitest/config";
import { sveltekit } from "@sveltejs/kit/vite";

export default defineConfig({
  plugins: [sveltekit()],
  test: {
    environment: "jsdom",
    globals: true,
  },
});
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ - æ­£å¸¸ç³»

`npm install`ã—ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€æœŸå¾…é€šã‚Šãƒ†ã‚¹ãƒˆã¯ãƒ‘ã‚¹ã—ã¾ã™ã€‚

```sh
$ npm run test

> frontend@0.0.1 test
> vitest

src/app.html does not exist

 DEV  v3.2.4 /Users/takayama/Document/vitest-sample

 âœ“ multiplier.svelte.test.js (1 test) 1ms
   âœ“ Multiplier 1ms

 Test Files  1 passed (1)
      Tests  1 passed (1)
   Start at  08:20:31
   Duration  756ms (transform 185ms, setup 0ms, collect 282ms, tests 1ms, environment 288ms, prepare 40ms)

 PASS  Waiting for file changes...
       press h to show help, press q to quit
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ - ã‚¨ãƒ©ãƒ¼

ã—ã‹ã—æ§‹æˆã‚’ãã®ã¾ã¾ã«ã€`.git`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­ã«å…¥ã‚Œã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚’ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

```sh
$ npm run test

> frontend@0.0.1 test
> vitest

src/app.html does not exist

 DEV  v3.2.4 /Users/takayama/Document/check/.git/vitest-sample

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯ Unhandled Errors â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯

Vitest caught 1 unhandled error during the test run.
This might cause false positive tests. Resolve unhandled errors to make sure your tests are not affected.

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯ Unhandled Error â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯
Error: Cannot find module '/@vite/env'
 â¯ VitestExecutor._fetchModule node_modules/vite-node/dist/client.mjs:247:19
 â¯ process.processTicksAndRejections node:internal/process/task_queues:105:5
 â¯ VitestExecutor.directRequest node_modules/vite-node/dist/client.mjs:268:44
 â¯ VitestExecutor.cachedRequest node_modules/vite-node/dist/client.mjs:189:11
 â¯ VitestExecutor.executeId node_modules/vite-node/dist/client.mjs:166:10
 â¯ createVitestExecutor node_modules/vitest/dist/chunks/execute.B7h3T_Hc.js:469:2
 â¯ startVitestExecutor node_modules/vitest/dist/chunks/execute.B7h3T_Hc.js:531:9
 â¯ startViteNode node_modules/vitest/dist/chunks/base.DfmxU-tU.js:10:14
 â¯ runBaseTests node_modules/vitest/dist/chunks/base.DfmxU-tU.js:24:30

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯
Serialized Error: { code: 'ERR_MODULE_NOT_FOUND' }
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯


 Test Files   (1)
      Tests  no tests
     Errors  1 error
   Start at  08:19:14
   Duration  143ms (transform 0ms, setup 0ms, collect 0ms, tests 0ms, environment 0ms, prepare 0ms)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
```

ä»Šå›ç”¨æ„ã—ãŸæœ€å°æ§‹æˆã¨ã¯åˆ¥ã«ã€`src/routes...`ãªã©ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã«ã—ã¦ã„ã‚‹å ´åˆã«ã€`/@vite/env`ã¨ã¯é•ã†åˆ¥ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã„ãšã‚Œã‚‚ã€å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã¨ã„ã†ã€åŒã˜åŸå› ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

```sh
 FAIL  src/routes/page.test.ts [ src/routes/page.test.ts ]
Error: Cannot find module '/Users/takayama/Document/check/.git/phantom/worktrees/feature-branch/frontend/src/routes/page.test.ts'
Caused by: Error: Failed to load url /Users/takayama/Document/check/.git/phantom/worktrees/feature-branch/frontend/src/routes/page.test.ts (resolved id: /Users/takayama/Document/check/.git/phantom/worktrees/feature-branch/frontend/src/routes/page.test.ts). Does the file exist?
 â¯ loadAndTransform ../node_modules/vite/dist/node/chunks/dep-DBxKXgDP.js:35725:17
```

## ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹åŸå› 

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã‹ã‚‰ã€`**/.git/**`ã«ãƒãƒƒãƒã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯èª­ã¿è¾¼ã¾ã‚Œãªã„ã¨ã„ã†ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãŒã‚ã‚Šã¾ã—ãŸã€‚

https://github.com/vitejs/vite/blob/main/docs/config/server-options.md#serverfsdeny

ä»¥ä¸‹ã«å¼•ç”¨ã—ã¾ã™ã€‚

> ### server.fs.deny
> 
> - **Type**: string[]
> - **Default**: ['.env', '.env.\*', '\*.{crt,pem}', '\*\*/.git/\*\*']
> 
> Blocklist for sensitive files being restricted to be served by Vite dev server. This will have higher priority than server.fs.allow. picomatch patterns are supported.

ã‚³ãƒ¼ãƒ‰ã ã¨ä»¥ä¸‹ã®ç®‡æ‰€ã§ã™ã€‚

https://github.com/vitejs/vite/blob/d2c81f7c13030c08becd8a768182074eedb87333/packages/vite/src/node/server/index.ts#L1097

ã“ã®è¨­å®šã®å½±éŸ¿ã§ã€`.git`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒé©åˆ‡ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ã¨ã„ã†çŠ¶æ³ãŒç™ºç”Ÿã—ã¦ã„ãŸã‚ˆã†ã§ã™ã€‚

`.git`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­ã§å®Ÿè¡Œã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ã¯æ—©ã„æ®µéšã§ã‚ã‹ã£ãŸã®ã§ã™ãŒã€ãªãœãã‚ŒãŒç™ºç”Ÿã™ã‚‹ã®ã‹ç†ç”±ã‚’çªãæ­¢ã‚ã‚‹ã®ã«æ‰‹é–“å–ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚å…·ä½“çš„ã«ã¯ã€`node_modules`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­ã‚’`.git`ã¨ã„ã†æ–‡å­—åˆ—ã§æ¼ã£ã¦ç·¨é›†ã—ãªãŒã‚‰ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨ã„ã†ãªã‚“ã¨ã‚‚æ³¥è‡­ã„æ–¹æ³•ã‚’å–ã‚Šã¾ã—ãŸã€‚

## è§£æ±ºæ–¹æ³•

åŸå› ãŒã‚ã‹ã£ãŸã®ã§ã€è§£æ±ºæ–¹æ³•ã‚‚ã‚ã‹ã‚Šã¾ã™ã€‚**`.git`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­ã§ä½œæ¥­ã‚’ã—ãªã„** ã“ã‚Œã«å°½ãã¾ã™ã€‚phantomã®å ´åˆã¯ã€`phantom.config.json`ã§ãƒ¯ãƒ¼ã‚¯ãƒ„ãƒªãƒ¼ã®ãƒ‘ã‚¹ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚

https://github.com/aku11i/phantom/blob/main/README.ja.md#phantom%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF

ã‚‚ã†ä¸€ã¤ã¯è¨­å®šã®ä¸Šæ›¸ãã§ã™ã€‚`server.fs.deny`ã‹ã‚‰ã€`**/.git/**`ã‚’å‰Šé™¤ã—ã¦ã—ã¾ãˆã°ã‚¨ãƒ©ãƒ¼ã¯ç™ºç”Ÿã—ãªããªã‚Šã¾ã™ã€‚ãŒã€æœ¬ç•ªç’°å¢ƒã§åˆ©ç”¨ã—ãªã„æ–¹ãŒã„ã„ã¨æ€ã‚ã‚Œã‚‹ã®ã§ã‚ãã¾ã§ä¸€æ™‚çš„ãªå¯¾å‡¦ã¨ã—ã¦è€ƒãˆãŸã»ã†ãŒè‰¯ã•ãã†ã§ã™ã€‚è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚

```ts:vite.config.ts
/// <reference types="vitest" />
import { defineConfig } from "vitest/config";
import { sveltekit } from "@sveltejs/kit/vite";

export default defineConfig({
  plugins: [sveltekit()],
  test: {
    environment: "jsdom",
    globals: true,
  },
  server: {
    fs: {
      strict: true,
      deny: [".env", ".env.*", "*.{crt,pem}"],
    },
  },
});
```

